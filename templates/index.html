<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¢ƒå¤–æŠ•èµ„ç¨åŠ¡è¯•ç®— </title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: #f5f7fa; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1); }

        /* èµ„é‡‘æµå‘é¢œè‰² */
        .amount-pos { color: #F56C6C; font-weight: bold; }
        .amount-neg { color: #67C23A; font-weight: bold; }
        .amount-neutral { color: #909399; }

        /* ç¨åŠ¡å¡ç‰‡æ ·å¼ */
        .tax-card { background: #fff; border: 1px solid #ebeef5; border-radius: 4px; padding: 20px; margin-bottom: 20px; display: flex; align-items: stretch; }
        .tax-item { flex: 1; text-align: center; border-right: 1px solid #ebeef5; padding: 0 15px; }
        .tax-item:last-child { border-right: none; }
        .tax-label { color: #909399; font-size: 14px; margin-bottom: 8px; }
        .tax-val { font-size: 20px; font-weight: bold; color: #303133; }
        .tax-val.danger { color: #F56C6C; }
        .tax-val.success { color: #67C23A; }

        .alert-box { background-color: #fdf6ec; color: #e6a23c; padding: 10px 15px; border-radius: 4px; font-size: 13px; margin-bottom: 15px; line-height: 1.6; }
    </style>
</head>
<body>
{% raw %}
<div id="app" class="container">

    <div style="margin-bottom: 20px; border-bottom: 1px solid #ebeef5; padding-bottom: 15px;">
        <h2 style="margin:0">ğŸ§¾ å¢ƒå¤–æŠ•èµ„ç¨åŠ¡è¯•ç®— (CN Tax Estimate)</h2>
        <div style="color: #606266; font-size: 14px; margin-top: 10px;">
            åŸºäºé•¿æ¡¥è¯åˆ¸èµ„é‡‘æµæ°´ï¼Œæ¨¡æ‹Ÿè®¡ç®—ä¸­å›½å¤§é™†å±…æ°‘ä¸ªäººæ‰€å¾—ç¨ï¼ˆç¨ç‡ 20%ï¼‰ã€‚
        </div>
    </div>

    <el-form :inline="true">
        <el-form-item label="ç»Ÿè®¡åŒºé—´">
            <el-date-picker
                    v-model="dateRange"
                    type="daterange"
                    range-separator="è‡³"
                    start-placeholder="å¼€å§‹"
                    end-placeholder="ç»“æŸ"
                    value-format="yyyy-MM-dd">
            </el-date-picker>
        </el-form-item>
        <el-form-item>
            <el-button type="primary" @click="fetchData" :loading="loading" icon="el-icon-calculator">è®¡ç®—ç¨é¢
            </el-button>
            <el-button type="success" @click="exportCSV" icon="el-icon-download" :disabled="isDataEmpty">å¯¼å‡º CSV
            </el-button>
        </el-form-item>
    </el-form>

    <el-tabs v-model="activeTab" type="card">
        <el-tab-pane v-for="mkt in markets" :key="mkt" :label="getMarketName(mkt)" :name="mkt">

            <div v-if="results[mkt] && results[mkt].records.length > 0">
                <div class="alert-box">
                    <i class="el-icon-warning"></i> <b>å…è´£å£°æ˜ï¼š</b>
                    æ­¤è®¡ç®—åŸºäºâ€œèµ„é‡‘æµæ°´â€ä¼°ç®—ã€‚å¯¹äº<b>æœªå–å‡º</b>çš„æŒä»“ï¼Œä¹°å…¥æˆæœ¬ä¼šè¢«è®¡ä¸ºè´Ÿç°é‡‘æµï¼Œå¯¼è‡´â€œäº¤æ˜“å‡€æ”¶ç›Šâ€åä½ã€‚
                    <br>å‡†ç¡®çš„æŠ¥ç¨è¯·ä»¥åˆ¸å•†æä¾›çš„å¹´åº¦ç»“å•ï¼ˆStatementï¼‰ä¸­çš„â€œRealized P/Lâ€ä¸ºå‡†ã€‚
                </div>

                <div class="tax-card">
                    <div class="tax-item">
                        <div class="tax-label">ğŸ“ˆ äº¤æ˜“å‡€æ”¶ç›Š (å·²æ‰£è´¹)</div>
                        <div :class="['tax-val', results[mkt].tax_report.trade_gain >= 0 ? 'danger' : 'success']">
                            {{ results[mkt].tax_report.trade_gain }}
                        </div>
                        <div style="font-size:12px; color:#C0C4CC; margin-top:4px;">å–å‡º - ä¹°å…¥ - è´¹ç”¨</div>
                    </div>
                    <div class="tax-item">
                        <div class="tax-label">ğŸ’° è‚¡æ¯/åˆ©æ¯æ‰€å¾—</div>
                        <div class="tax-val danger">{{ results[mkt].tax_report.dividend_gain }}</div>
                        <div style="font-size:12px; color:#C0C4CC; margin-top:4px;">å…¨é¢è®¡ç¨</div>
                    </div>
                    <div class="tax-item">
                        <div class="tax-label">ğŸ¦ å¢ƒå¤–å·²ç¼´ç¨ (æŠµæ‰£)</div>
                        <div class="tax-val">{{ results[mkt].tax_report.foreign_tax }}</div>
                    </div>
                    <div class="tax-item" style="background-color: #fef0f0; border-radius: 4px;">
                        <div class="tax-label" style="color:#F56C6C;">ğŸ‡¨ğŸ‡³ é¢„è®¡ä¸­å›½è¡¥ç¨é¢</div>
                        <div class="tax-val danger">{{ results[mkt].tax_report.est_china_tax }}</div>
                        <div style="font-size:12px; color:#F56C6C; margin-top:4px;">æŒ‰ 20% è¡¥å·®é¢</div>
                    </div>
                </div>

                <el-table :data="getPageData(mkt)" stripe border style="width: 100%; margin-top: 20px;">
                    <el-table-column prop="time" label="äº¤æ˜“æ—¶é—´" width="180"></el-table-column>
                    <el-table-column label="ç¨åŠ¡åˆ†ç±»" width="120">
                        <template slot-scope="scope">
                            <el-tag v-if="scope.row.tax_category === 'dividend'" type="warning" size="small">è‚¡æ¯çº¢åˆ©
                            </el-tag>
                            <el-tag v-else-if="scope.row.tax_category === 'trade_income'" type="danger" size="small">
                                å–å‡ºæ”¶å…¥
                            </el-tag>
                            <el-tag v-else-if="scope.row.tax_category === 'trade_cost'" type="success" size="small">
                                ä¹°å…¥/è´¹ç”¨
                            </el-tag>
                            <el-tag v-else-if="scope.row.tax_category === 'foreign_tax'" type="info" size="small">
                                å·²ç¼´ç¨æ¬¾
                            </el-tag>
                            <span v-else style="color:#ccc;">-</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="symbol" label="ä»£ç " width="100"></el-table-column>
                    <el-table-column prop="type_display" label="æ“ä½œ" width="120"></el-table-column>
                    <el-table-column prop="description" label="å¤‡æ³¨" show-overflow-tooltip></el-table-column>
                    <el-table-column label="é‡‘é¢" align="right" width="140">
                        <template slot-scope="scope">
                                <span :class="getAmountClass(scope.row)">
                                    {{ scope.row.amount > 0 ? '+' : '' }}{{ scope.row.amount }}
                                </span>
                            <span style="font-size:12px; color:#999;"> {{ scope.row.currency }}</span>
                        </template>
                    </el-table-column>
                </el-table>

                <div style="text-align: right; margin-top: 15px;">
                    <el-pagination
                            background
                            layout="prev, pager, next"
                            :total="results[mkt].records.length"
                            :page-size="pageSize"
                            :current-page.sync="currentPages[mkt]">
                    </el-pagination>
                </div>
            </div>

            <div v-else style="text-align: center; color: #909399; padding: 50px;">
                è¯·é€‰æ‹©æ—¥æœŸå¹¶ç‚¹å‡»â€œè®¡ç®—ç¨é¢â€
            </div>

        </el-tab-pane>
    </el-tabs>
</div>
{% endraw %}
<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            loading: false,
            dateRange: [],
            activeTab: 'US',
            markets: ['US', 'HK', 'CN', 'SG', 'OTHER'],
            pageSize: 10,
            currentPages: { 'US': 1, 'HK': 1, 'CN': 1, 'SG': 1, 'OTHER': 1 },
            results: {
                'US': { records: [], tax_report: { trade_gain:0, dividend_gain:0, foreign_tax:0, est_china_tax:0 } },
                'HK': { records: [], tax_report: { trade_gain:0, dividend_gain:0, foreign_tax:0, est_china_tax:0 } },
                'CN': { records: [], tax_report: { trade_gain:0, dividend_gain:0, foreign_tax:0, est_china_tax:0 } },
                'SG': { records: [], tax_report: { trade_gain:0, dividend_gain:0, foreign_tax:0, est_china_tax:0 } },
                'OTHER': { records: [], tax_report: { trade_gain:0, dividend_gain:0, foreign_tax:0, est_china_tax:0 } }
            }
        },
                    // åœ¨ Vue å®ä¾‹ data åé¢å¢åŠ 
        computed: {
            isDataEmpty() {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å¸‚åœºçš„ records é•¿åº¦å¤§äº 0
                return !Object.values(this.results).some(mkt => mkt.records && mkt.records.length > 0);
            }
        },
        methods: {
        exportCSV() {
if (this.isDataEmpty) return;

// 1. åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œç°¿ (Workbook)
const wb = XLSX.utils.book_new();

// 2. éå†å¸‚åœºï¼Œä¸ºæ¯ä¸ªå¸‚åœºåˆ›å»ºä¸€ä¸ª Sheet
this.markets.forEach(mkt => {
    const records = this.results[mkt].records;
    const taxReport = this.results[mkt].tax_report;

    // å¦‚æœè¯¥å¸‚åœºæ²¡æœ‰æ•°æ®ï¼Œå¯ä»¥è·³è¿‡æˆ–è€…åˆ›å»ºä¸€ä¸ªç©ºè¡¨
    if (!records || records.length === 0) return;

    // 3. æ„é€ è¯¥é¡µç­¾çš„æ•°æ®æ•°ç»„
    // é¦–å…ˆæ·»åŠ æ±‡æ€»ä¿¡æ¯
    let sheetData = [
        ["å¸‚åœºæ±‡æ€»ç»Ÿè®¡", "", "", "", "", "", ""],
        ["äº¤æ˜“å‡€æ”¶ç›Š", "è‚¡æ¯åˆ©æ¯æ‰€å¾—", "å¢ƒå¤–å·²ç¼´ç¨", "é¢„è®¡ä¸­å›½è¡¥ç¨é¢", "", "", ""],
        [taxReport.trade_gain, taxReport.dividend_gain, taxReport.foreign_tax, taxReport.est_china_tax, "", "", ""],
        [], // ç©ºè¡Œ
        ["è¯¦ç»†æµæ°´æ˜ç»†", "", "", "", "", "", ""],
        ["äº¤æ˜“æ—¶é—´", "ä»£ç ", "æ“ä½œç±»å‹", "ç¨åŠ¡åˆ†ç±»", "å¤‡æ³¨", "é‡‘é¢", "å¸ç§"] // è¡¨å¤´
    ];

    // 4. å¡«å……æ˜ç»†æ•°æ®
    records.forEach(row => {
        sheetData.push([
            row.time,
            row.symbol,
            row.type_display,
            row.tax_category,
            row.description,
            row.amount,
            row.currency
        ]);
    });

    // 5. å°†æ•°ç»„è½¬æ¢ä¸º Sheet å¹¶åŠ å…¥å·¥ä½œç°¿
    const ws = XLSX.utils.aoa_to_sheet(sheetData);

    // è®¾ç½®ä¸€ç‚¹åˆ—å®½ï¼ˆå¯é€‰ï¼‰
    ws['!cols'] = [{wch: 20}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 30}, {wch: 12}, {wch: 10}];

    XLSX.utils.book_append_sheet(wb, ws, this.getMarketName(mkt));
});

// 6. å¯¼å‡ºæ–‡ä»¶
const dateStr = this.dateRange[0] || 'export';
XLSX.writeFile(wb, `é•¿æ¡¥ç¨åŠ¡åˆ†ç±»æŠ¥è¡¨_${dateStr}.xlsx`);
this.$message.success('å¤šåˆ†é¡µ Excel å¯¼å‡ºæˆåŠŸ');
},
            getMarketName(key) {
                const map = {'US': 'ç¾è‚¡ (USD)', 'HK': 'æ¸¯è‚¡ (HKD)', 'CN': 'Aè‚¡ (CNY)', 'SG': 'æ–°åŠ å¡ (SGD)', 'OTHER': 'å…¶ä»–'};
                return map[key] || key;
            },
            getAmountClass(row) {
                if (!row.is_pl) return 'amount-neutral';
                return row.amount >= 0 ? 'amount-pos' : 'amount-neg';
            },
            fetchData() {
                if (!this.dateRange || this.dateRange.length < 2) {
                    this.$message.warning('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
                    return;
                }
                this.loading = true;
                axios.post('/api/tax_report', {
                    start_date: this.dateRange[0],
                    end_date: this.dateRange[1]
                }).then(res => {
                    if (res.data.status === 'success') {
                        this.results = res.data.data;
                        // é‡ç½®é¡µç 
                        for(let k in this.currentPages) this.currentPages[k] = 1;
                        this.$message.success('ç¨åŠ¡ä¼°ç®—å®Œæˆ');
                    } else {
                        this.$message.error(res.data.message);
                    }
                }).catch(err => {
                    this.$message.error('è¯·æ±‚å¤±è´¥');
                    console.error(err);
                }).finally(() => {
                    this.loading = false;
                });
            },
            getPageData(mkt) {
                const data = this.results[mkt];
                if (!data || !data.records) return [];
                const start = (this.currentPages[mkt] - 1) * this.pageSize;
                return data.records.slice(start, start + this.pageSize);
            }
        }
    })
</script>
</body>
</html>